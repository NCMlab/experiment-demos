<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="description" content="jsPsych ANT">
    <meta name="keywords" content="HTML, CSS, JavaScript">
    <meta name="author" content="Jason Steffener, NCMLab">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ANT</title>
    <script src="jspsych/jspsych.js"></script>
    <script src="jspsych/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="jspsych/plugins/jspsych-image-keyboard-response.js"></script>
    <script src="jspsych/plugins/jspsych-fullscreen.js"></script>
    <script src="jspsych/plugins/jspsych-instructions.js"></script>    
    <script src="ANT_Setup_EN.js"></script>
    <link href="jspsych/css/jspsych.css" rel="stylesheet" type="text/css">
    <style>
      .stimulus { font-size: 45; }
      .jspsych-html-keyboard-response-stimulus {font-size: 45;}
      .jspsych-display-element {
        font-family: 'Open Sans', 'Arial', sans-serif;
        font-size: 72px;
        line-height: 0.85em;
      }
      .center {
        margin-left: auto;
        margin-right: auto;
            }

    </style>
  </head>
  <script>
	/*<?php
		$post_data = json_decode(file_get_contents('php://input'), true); 
		// the directory "data" must be writable by the server
		$name = "data/".$post_data['filename'].".csv"; 
		$data = $post_data['filedata'];
		// write the file to disk
		file_put_contents($name, $data);
		?>*/

    /* create timeline */

    var timeline = [];
    // create the flankers
    // the number of flanking arrows is adjustable
    var NFlankers = 3;
    var flankersR = '';
    var flankersL = '';
    for (i = 0; i < NFlankers; i++) {
      flankersR += ">";
      flankersL += "<";
    }
  //https://www.webnots.com/keyboard-shortcuts-for-asterisk-symbol/
    var Stim = {
      type: 'html-keyboard-response',
      stimulus: function()
      { // The stimulus is mae based on the conditions laid out in the ANT 
        // variable read from teh setup file.
        // Recall that the ANT variable is an array of objects. 
        // The object contains everything there is know about this trial.
        // Read how this trial will be made
        var centralArrow = jsPsych.timelineVariable("centralArrow", true)
        var flanker = jsPsych.timelineVariable("flanker", true)
        var position = jsPsych.timelineVariable("position", true)
        
        // make the stimulus for this trial
        var stim = flanker + centralArrow + flanker
        // set the stimulus up in its position on the screen
        if (position == 'high')
        {stim = PutIntoTable(stim, '+',' ')}
        else {stim = PutIntoTable(' ','+',stim)}
        return stim
      },
      choices: KeyboardChoices,
      on_finish: function(data, correct){
        // find the correct response fpor this trial
        var correct = jsPsych.timelineVariable("correct", true)
        // in the list of allowable key presses, what is the index of wehat was pressed?
        var ResponseIndex = KeyboardChoices.indexOf(data.response)
        //console.log(ResponseMapping[ResponseIndex])
        
        if (ResponseMapping[ResponseIndex] == correct) 
          {data.correct = 1}
          else {data.correct = 0}
        /* If the ESCAPE key is pressed the current timeline is ended and the thank you screen is shown */
        if (data.key_press == 27) {jsPsych.end();}

        data.flankerType = jsPsych.timelineVariable("flankerType", true);
        data.cuePos = jsPsych.timelineVariable("cuePos", true);
        data.cueType = jsPsych.timelineVariable("cueType", true);
        data.trialType = 'trial';
      },

    } 

    var Fix = {
      // Each trial also has its own specific cue which occurs BEFORE the stimulus presentation
      // The cue itself is actually made in the setup file and not here. This could be changed if desired
      type: 'html-keyboard-response',
      stimulus: function()
      {
        var stim = jsPsych.timelineVariable("fixation", true)
        return stim
      },
      choices: jsPsych.NO_KEYS,
      trial_duration: 300,
      //on_finish: function(data){
      //  data.trialType = "fixation"
      //}
      
    } 

    var test_procedure = {
      // Make sure this order is correct: fixation cue and then the stimulus
      // Otherwise the scoring will not make any sense
      timeline: [Fix, Stim],
      timeline_variables: ANT,
      sample: {
        type: 'fixed-repetitions',
        // "fixed-repetitons": Repeat each item in the timeline variables size times, in a random order.
        // Unlike using the repetitons parameter, this method allows for consecutive trials to use the same
        // timeline variable set.
        size: 1, 
      }
    };
    timeline.push(test_procedure)
    /* start the experiment */
    //jatos.onLoad(function() {
    jsPsych.init({
        experiment_width: 600,
        timeline: timeline,
        on_finish: function() {
          jsPsych.data.get().localSave('csv','ANTMydata.csv');
        }
      })
  </script>
</html>