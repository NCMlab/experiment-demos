<!DOCTYPE html>
<html>
<head>
  <script src="jspsych-6.3.0/jspsych.js"></script>
  <script src="jspsych-6.3.0/plugins/jspsych-html-keyboard-response.js"></script> 
  <script src="jspsych-6.3.0/plugins/jspsych-preload.js"></script>
  <script src ="jspsych-6.3.0/plugins/jspsych-visual-search-circle.js"></script>
  <link rel="stylesheet" href="jspsych-6.3.0/css/jspsych.css"></link>
  <script src="visual_search_setup_EN.js"></script> 
  <meta charset="utf-8"/>
</head>
<body></body>
<script>

    let target_images = []

    if (experiment_type == 'conjunction') {
        target_images.push.apply(target_images, conjunction_target)
    } else if (experiment_type == 'shape') {
        target_images.push.apply(target_images, shape_target)
    } else {
        target_images.push.apply(target_images, colour_target)
    }

    var preload = {
        type: 'preload',
        images: foil_images.concat(target_images, [fixation]) 
    }
    //preloading all the images we need for the experiment

    const factors = {
        target_present: target_present, 
        // randomize whether or not the red T is present
        set_size: set_size, 
        //randomize number of distractors        
        target: target_images
    }
        
    const full_design = jsPsych.randomization.factorial(factors, repeat_trials)

    const block_len = Math.floor(full_design.length/block_number) 

    let prompt = {
        type: "html-keyboard-response",
        stimulus: prompt_msg
    }

    const welcome = {
        type: "html-keyboard-response",
        stimulus: "Welcome to the Visual Search Experiment. There will be " + block_number + " blocks in this experiment. There will be " + block_len + " trials in each block. You will be given a chance to take a break between blocks. Press any key to start the experiment."
    }

    //with timeline variables you define the procedure once (as a timeline) and specify a set of parameters and their values for each iteration through the timeline.
    let procedure = {
        timeline: [
            {
                    type: 'visual-search-circle',
                    target: jsPsych.timelineVariable('target'),
                    foil: function() {
                        let foil_set = foil_images
                        while ( foil_set.length < jsPsych.timelineVariable('set_size') ) {
                            foil_set = foil_set.concat(shuffle(foil_images))
                        }
                        return foil_set
                    },
                    target_present: jsPsych.timelineVariable('target_present'),
                    set_size: jsPsych.timelineVariable('set_size'),
                    target_present_key: the_present_key, 
                    target_absent_key: the_absent_key,
                    fixation_image: fixation,
                    data: {search_trial: true}
                    /*target_size:
                    fixation_size:
                    circle_diameter:
                    */
                    //these values should be in the setup file
            },
            {
                type: 'html-keyboard-response',
                stimulus: function(){
                        let t = jsPsych.data.get().filter({search_trial: true}).count() // trials so far
                        let trial_msg = "You have completed " + t + ' of ' + full_design.length + " trials.\n\n"+
                                        "Get ready for the next trial."
                        return trial_msg
                },
                choices: jsPsych.NO_KEYS,
                trial_duration: 1000,
                response_ends_trial: false
            }, 
            // break statement
            {
                timeline: [
                    { 
                        type: "html-keyboard-response",
                        stimulus: function() {
                            let t = jsPsych.data.get().filter({search_trial: true}).count()
                            let b = t / block_len
                            const html_out = 'You have completed ' + (t/full_design.length * 100).toFixed(0) + '% of the trials. You are on block ' + b + ' of 10. Good job! Take a break if you need to. Press any key to continue the experiment.'
                            return html_out
                        },
                        post_trial_gap: 1000
                    }
                ],
                conditional_function: function(){
                    let t = jsPsych.data.get().filter({search_trial: true}).count() // trials so far
                    if ( ( ( t % block_len ) == 0 ) && ( t < full_design.length ) ) {
                        return true;
                    } else {
                        return false;
                    }
                }
            }
        ],
        timeline_variables: full_design, 
        randomize_order: true
    }

    jsPsych.init({
        timeline: [welcome, prompt, procedure],
        on_finish: function() {
            jsPsych.data.get().localSave('csv','visual_search_data.csv');
        }
    });
    // shuffle any input array
    function shuffle(array) {
        // define three variables
        let cur_idx = array.length, tmp_val, rand_idx;
        // While there remain elements to shuffle...
        while (0 !== cur_idx) {
            // Pick a remaining element...
            rand_idx = Math.floor(Math.random() * cur_idx);
            cur_idx -= 1;
            // And swap it with the current element.
            tmp_val = array[cur_idx];
            array[cur_idx] = array[rand_idx];
            array[rand_idx] = tmp_val;
        }
        return array;
    }
</script>

</html>